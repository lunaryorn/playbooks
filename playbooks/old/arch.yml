- name: Install Arch Linux base system
  hosts: localhost
  tasks:
  # Base setup
  - name: "Configure kernel parameters"
    sysctl:
      name: "{{ item.key }}"
      value: "{{ item.value }}"
      sysctl_file: /etc/sysctl.d/lunaryorn-dotfiles.conf
    loop: "{{ items | dict2items }}"
    vars:
      items:
        # Disable NMI watchdog (powertop rec.)
        kernel.nmi_watchdog: "0"
        # Increase writeback time (default 500, powertop rec.)
        vm.dirty_writeback_centisecs: "1500"
        # The magic SysRq key enables certain keyboard combinations to be
        # interpreted by the kernel to help with debugging. The kernel will respond
        # to these keys regardless of the current running applications.
        #
        # In general, the magic SysRq key is not needed for the average Ubuntu
        # system, and having it enabled by default can lead to security issues on
        # the console such as being able to dump memory or to kill arbitrary
        # processes including the running screen lock.
        #
        # Here is the list of possible values:
        #   0 - disable sysrq completely
        #   1 - enable all functions of sysrq
        #  >1 - enable certain functions by adding up the following values:
        #          2 - enable control of console logging level
        #          4 - enable control of keyboard (SAK, unraw)
        #          8 - enable debugging dumps of processes etc.
        #         16 - enable sync command
        #         32 - enable remount read-only
        #         64 - enable signalling of processes (term, kill, oom-kill)
        #        128 - allow reboot/poweroff
        #        256 - allow nicing of all RT tasks
        #
        #   For example, to enable both control of console logging level and
        #   debugging dumps of processes: kernel.sysrq = 10
        #
        # 128 + 32 + 16
        kernel.sysrq: "176"

  - name: Install packages
    pacman:
      state: present
      name:
      - fwupd
      - ntfs-3g
      - exfat-utils
      - usbutils

      # Btrfs snapshots for backups and recovery
      - snapper
      - snap-pac
      # Additional pacman tools
      - pkgfile
      - oxipng
      - trash-cli
      # Tools
      - youtube-dl
      # Networking
      - networkmanager
      - avahi
      - nss-mdns
      # Development
      - httpie
      - meld
      - code
      - shellcheck
      - shfmt
      - hugo
      - ipython
      - python-pylint
      - autopep8
      - rustup
      - hub
      - github-cli
      - hexyl
      - asciidoctor
      # Virtual machines
      - virt-manager
      # Desktop services
      - cups
      - hplip
      - bluez
      - sane
      # Desktop
      - flatpak
      - xcursor-pinux
      - xdg-user-dirs
      - materia-gtk-theme
      - xdg-desktop-portal-gtk
      - wl-clipboard
      - keepassxc
      - firefox
      - firefox-i18n-de
      - zathura
      - zim
      - signal-desktop
      - d-feet
      - dconf-editor
      # Office
      - libreoffice-fresh
      - libreoffice-fresh-de
      - hyphen-de
      - hyphen-en
      - hunspell-de
      - hunspell-en_GB
      - hunspell-en_US
      - mythes-de
      - mythes-en
      # Multimedia Apps
      - pavucontrol
      - paprefs
      - gst-plugins-ugly
      - gstreamer-vaapi
      - vlc
      - audacious
      # Fonts
      - noto-fonts
      - noto-fonts-extra
      - noto-fonts-emoji
      - ttf-liberation
      - ttf-caladea
      - ttf-carlito
      - ttf-cascadia-code
      - ttf-fira-code
      - ttf-fira-mono
      - ttf-fira-sans
      - adobe-source-code-pro-fonts
      - adobe-source-sans-pro-fonts
      - adobe-source-serif-pro-fonts
      - ttf-roboto
      - ttf-ubuntu-font-family
      - ttf-fira-mono
      - ttf-fira-sans
      # Dependencies of my scripts
      - python-keyring
      - python-systemd
  - name: Install flatpaks
    flatpak:
      name: "{{ item }}"
      state: present
    loop:
      # Manage flatpak permissions
      - com.github.tchx84.Flatseal

  - name: Install Gnome
    tags: [gnome]
    pacman:
      state: present
      name:
      - gdm
      - gnome-shell
      - gnome-shell-extensions
      - gnome-tweaks
      - gnome-calculator
      - gnome-calendar
      - gnome-characters
      - gnome-clocks
      - gnome-disk-utility
      - gnome-font-viewer
      - gnome-logs
      - gnome-screenshot
      - gnome-shell-extensions
      - gnome-system-monitor
      - gnome-weather
      - gnome-terminal
      - seahorse
      - file-roller
      - yelp
      - cheese
      - nautilus
      - gvfs-afc
      - gvfs-goa
      - gvfs-google
      - gvfs-gphoto2
      - gvfs-mtp
      - gvfs-nfs
      - gvfs-smb
      - sushi
      - baobab
      - evince
      - eog
      - chrome-gnome-shell
      - remmina
      - simple-scan
      # Gtk Apps
      - gimp
      - inkscape
      - deja-dup

  # Optional deps
  - name: Optional dependencies
    pacman:
      state: present
      extra_args: --asdeps
      name:
        # zathura: PDF support
        - zathura-pdf-mupdf
        # zim: source code viewing and spell checking
        - gtksourceview3
        - gtkspell3
        # libva: Intel chipsets
        - intel-media-driver
        # virt-manager: NAT & KVM support
        - dnsmasq
        - ebtables
        - qemu

  # Configuration
  - name: Enable and start services
    systemd:
      unit: "{{ item }}"
      enabled: true
      state: started
    loop:
      # WiFi and network management
      - NetworkManager
      # mDNS support
      - avahi-daemon.service
      # pkgfile updates
      - pkgfile-update.timer
      # Printing
      - org.cups.cupsd.service
      # Bluetooth
      - bluetooth.service
      # Btrfs snapshots
      - snapper-timeline.timer
      - snapper-cleanup.timer
  - name: Enable multicast DNS name resolution
    lineinfile:
      path: /etc/nsswitch.conf
      regexp: "^hosts: "
      line: "hosts: files mymachines myhostname mdns_minimal [NOTFOUND=return] resolve [!UNAVAIL=return] dns"
  - name: Do not use resolved for multicast DNS (we use Avahi for this)
    lineinfile:
      path: /etc/systemd/resolved.conf
      insertafter: "#MulticastDNS=yes"
      regexp: "^MulticastDNS *="
      line: MulticastDNS=no
    notify:
      - Restart systemd-resolved

  - name: Create directory for dconf profiles
    file:
      path: /etc/dconf/profile
      state: directory
      mode: "0755"
  - name: Define dconf profile for gdm
    copy:
      dest: /etc/dconf/profile/gdm
      mode: "0644"
      content: |
        user-db:user
        system-db:gdm
        file-db:/usr/share/gdm/greeter-dconf-defaults
  - name: Configure font settings
    file:
      src: "../conf.avail/{{ item }}.conf"
      dest: "/etc/fonts/conf.d/{{ item }}.conf"
      state: link
    loop:
      # Hinting and subpixel aliasing
      - 10-hinting-slight
      - 10-sub-pixel-rgb
      # LCD filter, see https://wiki.archlinux.org/index.php/Font_configuration#LCD_filter
      - 11-lcdfilter-default

  - name: Check btrfs subvolumes for better snapper support
    command:
      cmd: "btrfs subvolume show {{ item }}"
    changed_when: False
    loop:
      - /srv
      - /var/tmp
      - /var/log
      - /var/cache
      - /var/cache/pacman/pkg
      - /var/lib/flatpak/repo

  # Boot loader entries
  - name: Install boot loader entries
    copy:
      dest: /boot/loader/entries/{{ item.key }}.conf
      content: |
        title {{ item.value.title }}
        linux /vmlinuz-{{ item.value.linux }}
        initrd /intel-ucode.img
        initrd /initramfs-{{ item.value.linux }}.img
        options quiet
    loop: "{{ items | dict2items }}"
    vars:
      items:
        arch:
          title: Arch
          linux: linux
        arch-lts:
          title: Arch LTS
          linux: linux-lts



  - name: Packages from AUR and my local repo
    pacman:
      state: present
      name:
      - git-gone
      - aurutils
      - otf-vollkorn
      - ttf-fira-go
      - xtermcontrol
      - git-delta
      - numix-circle-icon-theme-git
      - wcal-git

  handlers:
  - name: Restart systemd-resolved
    systemd:
      unit: systemd-resolved
      state: restarted
